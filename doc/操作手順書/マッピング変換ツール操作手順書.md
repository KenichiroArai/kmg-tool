# マッピング変換ツール操作手順書

## 1. 概要

マッピング変換ツールは、Java ファイル内の文字列を一括置換するためのツールである。安全な 2 段階置換方式を採用し、複数のファイルに対して一括でマッピング変換を実行する。

### 主な機能

- Java ファイル内の文字列の一括置換
- 2 段階置換方式による安全な変換処理
- 対象ディレクトリまたはファイルの指定
- 置換数の整合性検証
- 中間ファイルを経由した安全な処理

## 2. ファイル配置

### 2.1 ディレクトリ構造

```text
kmg-tool/
├── work/io/                          # 優先パス（開発時推奨）
│   └── input.txt                     # 入力ファイル
└── src/main/resources/tool/io/       # 代替パス
    └── input.txt                     # 入力ファイル
```

### 2.2 ファイルパスの優先順位

1. **優先パス**: `work/io/` ディレクトリが存在する場合
2. **代替パス**: `work/io/` ディレクトリが存在しない場合、`src/main/resources/tool/io/` を使用

## 3. 入力ファイルの準備

### 3.1 入力ファイル形式

入力ファイル（`input.txt`）は以下の構造で記述する：

```text
対象ファイルパス
対象値1,置換値1
対象値2,置換値2
...
```

### 3.2 入力ファイル例

```text
D:\wk\kmg-tool\src\main\java\com\example
oldPackageName,newPackageName
oldClassName,newClassName
oldMethodName,newMethodName
OldInterface,NewInterface
```

### 3.3 入力ファイルの注意事項

- 1 行目は対象ファイルパス（ディレクトリまたは単一ファイル）を絶対パスで記述する
- 2 行目以降はマッピングデータを「対象値,置換値」の形式で記述する
- カンマ（`,`）で対象値と置換値を区切る
- 空行は無視される
- 対象値と置換値の両方が必要である（どちらか一方だけでは無効）

## 4. 実行手順

### 4.1 基本的な実行方法

1. **入力ファイルの準備**

   ```bash
   # work/ioディレクトリを作成（存在しない場合）
   mkdir -p work/io

   # 入力ファイルを作成
   cat > work/io/input.txt << 'EOF'
   D:\wk\kmg-tool\src\main\java\com\example
   oldPackageName,newPackageName
   oldClassName,newClassName
   oldMethodName,newMethodName
   EOF
   ```

2. **ツールの実行**

   ```bash
   # Mavenを使用して実行
   mvn exec:java -Dexec.mainClass="kmg.tool.mptf.presentation.ui.cli.MapTransformTool"

   # または、JARファイルから実行
   java -cp target/classes:target/dependency/* kmg.tool.mptf.presentation.ui.cli.MapTransformTool
   ```

### 4.2 コマンドライン引数

現在のバージョンでは、コマンドライン引数は使用されない。ファイルパスは自動的に決定される。

### 4.3 実行時のログ出力

実行時には以下のようなログが出力される：

```text
[INFO] マッピング変換ツール開始
[INFO] 入力ファイル: work/io/input.txt
[INFO] 対象パス: src/main/java/com/example
[INFO] マッピングデータ: 3件
[INFO] 第1段階: 対象値をUUIDに置換中...
[INFO] 第2段階: UUIDを置換値に置換中...
[INFO] 置換処理完了: UUID置換数=15, 置換値置換数=15
[INFO] マッピング変換ツール終了
```

## 5. 処理の詳細

### 5.1 2 段階置換方式

マッピング変換ツールは安全性を確保するため、2 段階の置換処理を採用している：

1. **第 1 段階**: 対象値を UUID に一時置換

   - すべての対象値を一意の UUID に置換
   - UUID と置換値のマッピングを作成

2. **第 2 段階**: UUID を最終的な置換値に置換
   - 第 1 段階で生成した UUID を対応する置換値に置換

### 5.2 置換処理の安全性

この方式により、以下の問題を回避できる：

- **問題例**: `oldName,newName` と `newName,anotherName` のマッピングがある場合
- **直接置換**: `oldName` が `anotherName` に誤って置換される
- **2 段階置換**: `oldName` は正しく `newName` に置換される

### 5.3 置換数の整合性検証

処理完了時に以下の検証が実行される：

- UUID 置換数と置換値置換数が一致することを確認
- 不一致の場合はエラーメッセージを出力
