# インタフェースアクセサ作成ツール設計書

## 1. クラス図

```mermaid
classDiagram
    %% 継承関係
    AbstractTool <|-- AbstractIoTool
    AbstractIoTool <|-- AbstractTwo2OneTool
    AbstractTwo2OneTool <|-- AbstractDtcTool
    AbstractDtcTool <|-- InterfaceAccessorCreationTool

    %% インターフェース実装関係
    IitoProcessorService <|.. AccessorCreationService
    IctoOneLinePatternLogic <|.. AccessorCreationLogic

    %% サービス実装関係
    AbstractIitoProcessorService ..|> IitoProcessorService
    AccessorCreationServiceImpl --|> AbstractIitoProcessorService
    AccessorCreationServiceImpl ..|> AccessorCreationService
    AccessorCreationLogicImpl --|> AbstractIctoOneLinePatternLogic
    AccessorCreationLogicImpl ..|> AccessorCreationLogic

    %% ロジック関係
    InterfaceAccessorCreationTool --> AccessorCreationService : uses
    AccessorCreationServiceImpl --> AccessorCreationLogic : uses
    AccessorCreationServiceImpl --> DtcService : uses

    %% テンプレート関連
    InterfaceAccessorCreationTool ..> InterfaceAccessorCreationTool.yml : uses template

    class AbstractTool {
        +boolean execute()
    }

    class AbstractIoTool {
        -String toolName
        +static Path getBasePath()
        +static Path getInputPath()
        +static Path getOutputPath()
        +boolean execute()
        #abstract IoService getIoService()
    }

    class AbstractTwo2OneTool {
        -Logger logger
        -Path templatePath
        +Path getTemplatePath()
        +boolean initialize()
        #abstract Two2OneService getIoService()
    }

    class AbstractDtcTool {
        +AbstractDtcTool(String toolName)
        #abstract IitoProcessorService getIoService()
    }

    class InterfaceAccessorCreationTool {
        -static String TOOL_NAME
        -AccessorCreationService accessorCreationService
        +static void main(String[] args)
        +InterfaceAccessorCreationTool()
        #AccessorCreationService getIoService()
    }

    class IitoProcessorService {
        <<interface>>
        +Path getInputPath()
        +Path getOutputPath()
        +Path getTemplatePath()
        +boolean initialize(Path inputPath, Path templatePath, Path outputPath)
        +boolean process()
    }

    class AccessorCreationService {
        <<interface>>
    }

    class DtcService {
        <<interface>>
        +boolean initialize(Path inputPath, Path templatePath, Path outputPath)
        +boolean process()
    }

    class AbstractIitoProcessorService {
        -Path inputPath
        -Path templatePath
        -Path outputPath
        -Path intermediatePath
        -DtcService dtcService
        +Path getInputPath()
        +Path getOutputPath()
        +Path getTemplatePath()
        +Path getIntermediatePath()
        +boolean initialize(Path inputPath, Path templatePath, Path outputPath)
        +boolean process()
        #abstract boolean writeIntermediateFile()
    }

    class AccessorCreationServiceImpl {
        -Logger logger
        -KmgMessageSource messageSource
        -AccessorCreationLogic accessorCreationLogic
        +AccessorCreationServiceImpl()
        #boolean writeIntermediateFile()
        -boolean addNameColumn()
        -boolean addRemainingColumns()
        -void clearAndPrepareNextLine()
        -void closeAccessorCreationLogic()
        -boolean processColumns()
        -boolean readOneLineData()
        -void writeIntermediateFileLine()
    }

    class IctoOneLinePatternLogic {
        <<interface>>
        +boolean addRow(String value)
        +boolean clearRows()
        +boolean clearProcessingData()
        +boolean readOneLineOfData()
        +boolean writeIntermediateFile()
        +String getConvertedLine()
    }

    class AccessorCreationLogic {
        <<interface>>
        +boolean addItemToRows()
        +boolean addJavadocCommentToRows()
        +boolean addTypeToRows()
        +boolean convertFields()
        +boolean convertJavadoc()
        +String getItem()
        +String getJavadocComment()
        +String getTyep()
        +boolean isInJavadocParsing()
        +boolean removeModifier()
    }

    class AbstractIctoOneLinePatternLogic {
        -Logger logger
        -KmgMessageSource messageSource
        -Path inputPath
        -Path outputPath
        -BufferedReader reader
        -BufferedWriter writer
        -String lineOfDataRead
        -String convertedLine
        -KmgDelimiterTypes outputDelimiter
        -int nowLineNumber
        -List~List~String~~ rows
        +boolean addRow(String value)
        +boolean clearRows()
        +boolean clearProcessingData()
        +boolean readOneLineOfData()
        +boolean writeIntermediateFile()
        +String getConvertedLine()
    }

    class AccessorCreationLogicImpl {
        -boolean inJavadocParsing
        -String javadocComment
        -String type
        -String item
        +boolean addItemToRows()
        +boolean addJavadocCommentToRows()
        +boolean addTypeToRows()
        +boolean convertFields()
        +boolean convertJavadoc()
        +String getItem()
        +String getJavadocComment()
        +String getTyep()
        +boolean isInJavadocParsing()
        +boolean removeModifier()
    }

    class InterfaceAccessorCreationTool.yml {
        intermediatePlaceholders
        derivedPlaceholders
        templateContent
    }
```

## 2. シーケンス図

```mermaid
sequenceDiagram
    participant User as ユーザー
    participant IACT as InterfaceAccessorCreationTool
    participant ADT as AbstractDtcTool
    participant AT2OT as AbstractTwo2OneTool
    participant AIT as AbstractIoTool
    participant ACService as AccessorCreationServiceImpl
    participant AIPS as AbstractIitoProcessorService
    participant ACLogic as AccessorCreationLogicImpl
    participant DtcService as DtcService
    participant Template as InterfaceAccessorCreationTool.yml
    participant Input as input.txt
    participant Intermediate as 中間ファイル
    participant Output as output.txt

    User->>IACT: アプリケーション起動
    Note over IACT: main(String[] args)
    IACT->>IACT: SpringApplication.run
    IACT->>IACT: run(args)

    IACT->>AT2OT: initialize()
    AT2OT->>ACService: initialize(inputPath, templatePath, outputPath)
    ACService->>AIPS: initialize(inputPath, templatePath, outputPath)
    AIPS->>AIPS: createTempntermediateFile()

    IACT->>AIT: execute()
    AIT->>IACT: getIoService()
    IACT-->>AIT: accessorCreationService
    AIT->>ACService: process()
    ACService->>AIPS: process()
    AIPS->>ACService: writeIntermediateFile()

    ACService->>ACLogic: initialize(inputPath, intermediatePath)
    ACService->>ACLogic: addOneLineOfDataToRows()

    loop 入力ファイル処理
        ACService->>ACLogic: readOneLineOfData()
        ACLogic-->>Input: ファイル読み込み

        ACService->>ACService: processColumns()

        ACService->>ACService: addNameColumn()
        ACService->>ACLogic: convertJavadoc()
        ACLogic->>ACLogic: Javadocコメント抽出処理
        ACService->>ACLogic: addJavadocCommentToRows()
        ACLogic->>Intermediate: 中間ファイルにJavadocコメント追加

        ACService->>ACService: addRemainingColumns()
        ACService->>ACLogic: removeModifier()
        ACLogic->>ACLogic: 不要な修飾子を削除

        ACService->>ACLogic: convertFields()
        ACLogic->>ACLogic: フィールド情報抽出処理

        ACService->>ACLogic: addTypeToRows()
        ACLogic->>Intermediate: 中間ファイルに型情報追加

        ACService->>ACLogic: addItemToRows()
        ACLogic->>Intermediate: 中間ファイルに項目名追加

        ACService->>ACLogic: writeIntermediateFile()
        ACLogic->>Intermediate: 中間ファイル書き込み

        ACService->>ACService: clearAndPrepareNextLine()
        ACService->>ACLogic: clearRows()
        ACService->>ACLogic: clearProcessingData()
        ACService->>ACLogic: addOneLineOfDataToRows()
    end

    AIPS->>DtcService: initialize(intermediatePath, templatePath, outputPath)
    AIPS->>DtcService: process()
    DtcService->>Template: テンプレート読み込み
    DtcService->>Intermediate: 中間ファイル読み込み

    loop テンプレート適用処理
        DtcService->>DtcService: readOneLineData()
        DtcService->>DtcService: applyTemplateToInputFile()
        DtcService->>DtcService: addOutputBufferContent()
        DtcService->>DtcService: writeOutputBuffer()
        DtcService->>DtcService: clearOutputBufferContent()
    end

    DtcService->>Output: 出力ファイル生成

    ACService->>ACLogic: close()
    ACLogic->>ACLogic: closeReader()
    ACLogic->>ACLogic: closeWriter()

    IACT-->>User: 処理完了
```

## 3. テンプレートファイル構造

InterfaceAccessorCreationTool.yml は以下の構造を持っています：

1. **intermediatePlaceholders**: 中間ファイルから直接取得するプレースホルダー定義

   - displayName: 画面表示用の名称
   - replacementPattern: 置換対象のパターン

2. **derivedPlaceholders**: 中間ファイルから取得した値を変換して生成するプレースホルダー定義

   - displayName: 画面表示用の名称
   - replacementPattern: 置換対象のパターン
   - sourceKey: 変換元となる中間プレースホルダーの displayName
   - transformation: 適用する変換処理

3. **templateContent**: テンプレートの内容
   - {name}, {type}, {item}, {capitalize}のプレースホルダーが実際の値に置換される

## 4. 処理フロー詳細

1. ユーザーがアプリケーションを起動
2. SpringBoot アプリケーションが起動し、InterfaceAccessorCreationTool のインスタンスが生成される
3. AbstractTwo2OneTool の initialize()メソッドが呼び出され、AccessorCreationService が初期化される
4. AbstractIoTool の execute()メソッドが呼び出され、メイン処理が実行される
5. AccessorCreationServiceImpl の writeIntermediateFile()メソッドが実行され、入力ファイルの処理が開始される
6. 入力ファイルから 1 行ずつデータを読み込み、以下の処理を行う：
   - Javadoc コメントの抽出と変換
   - 不要な修飾子（final や static）の削除
   - フィールド定義から型情報と項目名の抽出
   - 中間ファイル形式に変換して中間ファイルに書き込み
7. 中間ファイルの生成が完了したら、DtcService（テンプレートの動的変換サービス）を使用して：
   - テンプレートファイル（InterfaceAccessorCreationTool.yml）を読み込む
   - 中間ファイルのデータを読み込む
   - テンプレートにデータを適用して出力ファイルを生成する
8. リソースがクローズされ、処理が完了する

## 5. 主要コンポーネント

### InterfaceAccessorCreationTool

- SpringBootApplication として動作するエントリーポイント
- AbstractDtcTool を継承（さらに AbstractTwo2OneTool を継承）
- AccessorCreationService を使用してインタフェース用アクセサ生成を実行

### AbstractDtcTool

- AbstractTwo2OneTool を継承
- テンプレートの動的変換ツールの抽象クラス
- IitoProcessorService を返す抽象メソッドを定義

### AbstractTwo2OneTool

- AbstractIoTool を継承
- テンプレートファイルパスの管理と初期化処理を担当

### AccessorCreationServiceImpl

- AbstractIitoProcessorService を継承
- AccessorCreationService インターフェースを実装
- 入力ファイルの読み込みと中間ファイル形式への変換を担当

### AccessorCreationLogicImpl

- AbstractIctoOneLinePatternLogic を継承
- AccessorCreationLogic インターフェースを実装
- アクセサ作成の実際のロジックを担当
- フィールド定義からアクセサメソッドに必要な情報を抽出
- 中間ファイル形式の中間ファイルを生成

### DtcService（テンプレートの動的変換サービス）

- テンプレートファイルと中間ファイルデータを使用して最終的な出力ファイルを生成
- プレースホルダの置換処理を担当

### テンプレートファイル（InterfaceAccessorCreationTool.yml）

- YAML フォーマットで定義されたテンプレート設定ファイル
- 以下の主要セクションで構成：
  - `intermediatePlaceholders`: 中間ファイルから直接取得するプレースホルダー定義
  - `derivedPlaceholders`: 中間ファイルから取得した値を変換して生成するプレースホルダー定義
  - `templateContent`: 実際のテンプレート内容

#### intermediatePlaceholders

- 中間ファイルの各列から直接マッピングされるプレースホルダー
  - `{name}`: フィールドの名称（Javadoc コメント）
  - `{type}`: フィールドの型
  - `{item}`: フィールド名

#### derivedPlaceholders

- 既存のプレースホルダーから変換して生成される派生プレースホルダー
  - `{capitalize}`: 項目名の先頭を大文字にした値（例: item → Item）
  - 変換元: `項目`（`{item}`）
  - 変換処理: `capitalize`（先頭大文字化）

#### templateContent

- インタフェース用の getter と setter のテンプレートを定義
- 上記のプレースホルダーを使用して、フィールドごとにカスタマイズされたアクセサメソッドを生成
- 各メソッドには Javadoc コメントも含まれる

## 6. 特徴

### インタフェース専用設計

- 通常のアクセサ作成ツールとは異なり、インタフェース用のメソッド定義を生成
- 実装ではなく、メソッドの宣言のみを生成
- インタフェースの特性に合わせた Javadoc コメントを自動生成

### 柔軟なテンプレートシステム

- YAML 形式のテンプレート設定により、出力形式をカスタマイズ可能
- プレースホルダーの変換機能により、動的な値の生成が可能
- 中間ファイルを経由することで、複雑な変換処理を実現

### 堅牢なエラーハンドリング

- 各段階での適切な例外処理
- ログ出力による処理状況の可視化
- リソースの適切な管理とクリーンアップ
