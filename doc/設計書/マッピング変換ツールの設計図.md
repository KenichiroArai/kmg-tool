# マッピング変換ツール設計書

## 1. クラス図

```mermaid
classDiagram
    %% 継承関係
    AbstractTool <|-- AbstractInputTool
    AbstractInputTool <|-- AbstractPlainContentInputTool
    AbstractPlainContentInputTool <|-- MapTransformTool

    %% インターフェース実装関係
    InputService <|.. PlainContentInputServic
    PlainContentInputServic <|.. PlainContentInputServiceImpl
    MapTransformService <|.. MapTransformServiceImpl
    JdtsIoLogic <|.. JdtsIoLogicImpl

    %% サービス実装関係
    AbstractInputService ..|> InputService
    PlainContentInputServiceImpl --|> AbstractInputService
    PlainContentInputServiceImpl ..|> PlainContentInputServic

    %% ロジック関係
    MapTransformTool --> PlainContentInputServic : uses
    MapTransformTool --> MapTransformService : uses
    MapTransformServiceImpl --> JdtsIoLogic : uses

    %% 入力ファイル関連
    MapTransformTool ..> input.txt : uses input file

    class AbstractTool {
        +boolean execute()
    }

    class AbstractInputTool {
        +static Path getBasePath()
        +static Path getInputPath()
        +static Path getPrimaryBasePath()
        +static Path getSecondaryBasePath()
        #abstract InputService getInputService()
    }

    class AbstractPlainContentInputTool {
        -String content
        +String getContent()
        +boolean loadPlainContent(Path inputPath)
        #abstract PlainContentInputServic getInputService()
    }

    class MapTransformTool {
        -static String TOOL_NAME
        -KmgMessageSource messageSource
        -PlainContentInputServic inputService
        -MapTransformService mapTransformService
        -Path targetPath
        -Map~String,String~ mapping
        +static void main(String[] args)
        +MapTransformTool()
        +boolean execute()
        +PlainContentInputServic getInputService()
        -boolean fromInputFile()
    }

    class InputService {
        <<interface>>
        +boolean initialize(Path inputPath)
        +boolean process()
    }

    class PlainContentInputServic {
        <<interface>>
        +String getContent()
    }

    class PlainContentInputServiceImpl {
        -Logger logger
        -KmgMessageSource messageSource
        -Path inputPath
        -String content
        +PlainContentInputServiceImpl()
        +String getContent()
        +boolean initialize(Path inputPath)
        +boolean process()
    }

    class AbstractInputService {
        -Logger logger
        -KmgMessageSource messageSource
        -Path inputPath
        +boolean initialize(Path inputPath)
        +boolean process()
    }

    class MapTransformService {
        <<interface>>
        +Path getTargetPath()
        +boolean initialize(Path targetPath, Map~String,String~ mapping)
        +boolean process()
    }

    class MapTransformServiceImpl {
        -Logger logger
        -KmgMessageSource messageSource
        -JdtsIoLogic jdtsIoLogic
        -Path targetPath
        -Map~String,String~ targetValueToReplacementValueMapping
        -Map~String,String~ uuidToReplacementValueMapping
        +MapTransformServiceImpl()
        +Path getTargetPath()
        +boolean initialize(Path targetPath, Map~String,String~ mapping)
        +boolean process()
        -long replaceTargetValuesWithUuid()
        -long replaceUuidWithReplacementValues()
    }

    class JdtsIoLogic {
        <<interface>>
        +Path getCurrentFilePath()
        +List~Path~ getFilePathList()
        +String getReadContent()
        +Path getTargetPath()
        +boolean initialize(Path targetPath)
        +boolean load()
        +boolean loadContent()
        +boolean nextFile()
        +boolean resetFileIndex()
        +void setWriteContent(String content)
        +boolean writeContent()
    }

    class JdtsIoLogicImpl {
        -static String TARGET_FILE_EXTENSION
        -Path targetPath
        -List~Path~ filePathList
        -int currentFileIndex
        -Path currentFilePath
        -String readContent
        -String writeContent
        +JdtsIoLogicImpl()
        +Path getCurrentFilePath()
        +List~Path~ getFilePathList()
        +String getReadContent()
        +Path getTargetPath()
        +boolean initialize(Path targetPath)
        +boolean load()
        +boolean loadContent()
        +boolean nextFile()
        +boolean resetFileIndex()
        +void setWriteContent(String content)
        +boolean writeContent()
    }

    class input.txt {
        targetFilePath
        mappingData
    }
```

## 2. シーケンス図

```mermaid
sequenceDiagram
    participant User as ユーザー
    participant MTT as MapTransformTool
    participant APIT as AbstractPlainContentInputTool
    participant AIT as AbstractInputTool
    participant PCIS as PlainContentInputServiceImpl
    participant MTS as MapTransformServiceImpl
    participant JIL as JdtsIoLogicImpl
    participant Input as input.txt
    participant TargetFiles as 対象Javaファイル群

    User->>MTT: アプリケーション起動
    Note over MTT: main(String[] args)
    MTT->>MTT: SpringApplication.run
    MTT->>MTT: execute()

    MTT->>MTT: fromInputFile()
    MTT->>APIT: loadPlainContent(inputPath)
    APIT->>AIT: getInputPath()
    AIT-->>APIT: input.txtのパス
    APIT->>PCIS: initialize(inputPath)
    APIT->>PCIS: process()
    PCIS->>Input: ファイル読み込み
    Input-->>PCIS: ファイル内容
    PCIS-->>APIT: 処理結果
    APIT-->>MTT: ファイル内容

    MTT->>MTT: 入力内容解析
    Note over MTT: 1行目: 対象ファイルパス<br/>2行目以降: マッピングデータ

    MTT->>MTS: initialize(targetPath, mapping)
    MTS->>JIL: initialize(targetPath)
    JIL->>JIL: 対象パス設定

    MTT->>MTS: process()
    MTS->>JIL: load()
    JIL->>TargetFiles: Javaファイル検索・リスト化

    loop 対象値からUUIDへの置換
        MTS->>JIL: nextFile()
        JIL-->>MTS: 次のファイル存在確認
        MTS->>JIL: loadContent()
        JIL->>TargetFiles: ファイル内容読み込み
        TargetFiles-->>JIL: ファイル内容
        JIL-->>MTS: 読み込み内容

        MTS->>MTS: replaceTargetValuesWithUuid()
        Note over MTS: 対象値をUUIDに一時置換<br/>UUIDと置換値のマッピング作成
        MTS->>JIL: setWriteContent(置換後内容)
        MTS->>JIL: writeContent()
        JIL->>TargetFiles: ファイル書き込み
    end

    MTS->>JIL: resetFileIndex()

    loop UUIDから置換値への置換
        MTS->>JIL: nextFile()
        JIL-->>MTS: 次のファイル存在確認
        MTS->>JIL: loadContent()
        JIL->>TargetFiles: ファイル内容読み込み
        TargetFiles-->>JIL: ファイル内容
        JIL-->>MTS: 読み込み内容

        MTS->>MTS: replaceUuidWithReplacementValues()
        Note over MTS: UUIDを最終的な置換値に置換
        MTS->>JIL: setWriteContent(置換後内容)
        MTS->>JIL: writeContent()
        JIL->>TargetFiles: ファイル書き込み
    end

    MTS->>MTS: 置換数検証
    Note over MTS: UUID置換数と置換値置換数が一致することを確認

    MTS-->>MTT: 処理完了
    MTT-->>User: 処理完了
```

## 3. 入力ファイル構造

input.txt は以下の構造を持っています：

1. **1 行目**: 対象ファイルパス

   - マッピング変換を実行する対象のディレクトリまたはファイルパス

2. **2 行目以降**: マッピングデータ
   - 各行は「対象値,置換値」の形式
   - カンマ区切りで対象値と置換値を指定
   - 空行は無視される

### 入力ファイル例

```text
src/main/java/com/example
oldPackageName,newPackageName
oldClassName,newClassName
oldMethodName,newMethodName
```

## 4. 処理フロー詳細

1. ユーザーがアプリケーションを起動
2. SpringBoot アプリケーションが起動し、MapTransformTool のインスタンスが生成される
3. MapTransformTool の execute()メソッドが呼び出され、メイン処理が実行される
4. fromInputFile()メソッドが実行され、入力ファイルの処理が開始される：
   - AbstractInputTool.getInputPath()で入力ファイルパスを取得
   - PlainContentInputService を使用して input.txt を読み込み
   - 読み込んだ内容を行に分割して解析
   - 1 行目から対象ファイルパスを取得
   - 2 行目以降からマッピングデータを解析して Map に格納
5. MapTransformService の初期化と処理が実行される：
   - initialize()メソッドで対象パスとマッピングデータを設定
   - JdtsIoLogic を使用して対象ディレクトリから Java ファイルを検索・リスト化
6. 2 段階の置換処理が実行される：
   - **第 1 段階**: 対象値を UUID に一時置換
     - 各 Java ファイルの内容を読み込み
     - マッピングの対象値を UUID に置換
     - UUID と置換値のマッピングを作成
     - 置換後の内容をファイルに書き込み
   - **第 2 段階**: UUID を最終的な置換値に置換
     - 各 Java ファイルの内容を読み込み
     - UUID を対応する置換値に置換
     - 置換後の内容をファイルに書き込み
7. 置換数の整合性を検証（UUID 置換数と置換値置換数が一致することを確認）
8. 処理が完了し、結果がユーザーに返される

## 5. 主要コンポーネント

### MapTransformTool

- SpringBootApplication として動作するエントリーポイント
- AbstractPlainContentInputTool を継承（さらに AbstractInputTool を継承）
- PlainContentInputService を使用して入力ファイルを読み込み
- MapTransformService を使用してマッピング変換を実行

### AbstractPlainContentInputTool

- AbstractInputTool を継承
- プレーンコンテンツ（テキストファイル）の入力処理を担当
- 入力ファイルから文字列コンテンツを読み込む機能を提供

### AbstractInputTool

- AbstractTool を継承
- 入力ファイルパスの管理を担当
- work/io/input.txt を優先し、存在しない場合は src/main/resources/tool/io/input.txt を使用

### PlainContentInputServiceImpl

- AbstractInputService を継承
- PlainContentInputService インターフェースを実装
- 入力ファイルからプレーンテキストコンテンツを読み込む処理を担当

### MapTransformServiceImpl

- MapTransformService インターフェースを実装
- マッピング変換の実際の処理を担当
- JdtsIoLogic を使用して Java ファイルの入出力を管理
- 2 段階の置換処理（対象値 →UUID→ 置換値）を実装

### JdtsIoLogicImpl

- JdtsIoLogic インターフェースを実装
- Java ファイルの入出力処理を担当
- 対象ディレクトリから .java ファイルを検索・リスト化
- ファイルの読み込み・書き込み処理を提供

## 6. 特徴と利点

### 2 段階置換方式の採用

- **問題**: 直接置換では、置換値が他の対象値と重複する場合に意図しない置換が発生する可能性
- **解決**: 対象値 →UUID→ 置換値の 2 段階置換により、置換の安全性を確保
- **例**: `oldName,newName` と `newName,anotherName` のマッピングがある場合、直接置換では `oldName` が `anotherName` に置換されてしまうが、2 段階置換では正しく `newName` に置換される

### 置換数の整合性検証

- UUID 置換数と置換値置換数が一致することを確認
- 置換処理の正確性を保証

### 柔軟な入力ファイル形式

- シンプルなテキスト形式でマッピングデータを定義
- カンマ区切りで対象値と置換値を指定
- 空行の無視により、可読性の向上

### Spring Boot による依存性注入

- 各コンポーネントが疎結合で設計
- テスト容易性の向上
- 設定の柔軟性
