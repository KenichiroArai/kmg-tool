# 入力、中間、テンプレート、出力設計図

## 1. クラス図

```mermaid
classDiagram
    %% 継承関係
    AbstractTool <|-- AbstractIoTool
    AbstractIoTool <|-- AbstractTwo2OneTool
    AbstractTwo2OneTool <|-- AbstractIitoTool
    AbstractIitoTool <|-- IitoTool

    %% インターフェース実装関係
    Two2OneService <|.. IitoProcessorService
    IitoProcessorService <|.. AbstractIitoProcessorService
    IctoOneLinePatternLogic <|.. AbstractIctoOneLinePatternLogic

    %% サービス関係
    AbstractIitoProcessorService --> IctoOneLinePatternLogic : uses
    AbstractIitoProcessorService --> DtcService : uses
    AbstractIctoOneLinePatternLogic --> KmgDelimiterTypes : uses

    %% テンプレート関連
    IitoTool ..> IitoTool.yml : uses template

    class AbstractTool {
        +boolean execute()
    }

    class AbstractIoTool {
        -String toolName
        +static Path getBasePath()
        +static Path getInputPath()
        +static Path getOutputPath()
        +boolean execute()
        #abstract IoService getIoService()
    }

    class AbstractTwo2OneTool {
        -Logger logger
        -Path templatePath
        +Path getTemplatePath()
        +boolean initialize()
        #abstract Two2OneService getIoService()
    }

    class AbstractIitoTool {
        +AbstractIitoTool(String toolName)
        #abstract IitoProcessorService getIoService()
    }

    class IitoTool {
        -static String TOOL_NAME
        -IitoProcessorService iitoProcessorService
        +static void main(String[] args)
        +IitoTool()
        +void run(String[] args)
        #IitoProcessorService getIoService()
    }

    class Two2OneService {
        <<interface>>
        +Path getInputPath()
        +Path getOutputPath()
        +Path getTemplatePath()
        +boolean initialize(Path inputPath, Path templatePath, Path outputPath)
        +boolean process()
    }

    class IitoProcessorService {
        <<interface>>
    }

    class AbstractIitoProcessorService {
        -Logger logger
        -KmgMessageSource messageSource
        -Path inputPath
        -Path templatePath
        -Path outputPath
        -Path intermediatePath
        -DtcService dtcService
        +AbstractIitoProcessorService()
        +Path getInputPath()
        +Path getTemplatePath()
        +Path getOutputPath()
        +Path getIntermediatePath()
        +boolean initialize(Path inputPath, Path templatePath, Path outputPath)
        +boolean process()
        -Path createTempntermediateFile()
        #abstract boolean writeIntermediateFile()
    }

    class IctoOneLinePatternLogic {
        <<interface>>
        +boolean addOneLineOfDataToRows()
        +boolean clearProcessingData()
        +boolean clearRows()
        +String getConvertedLine()
        +String getLineOfDataRead()
        +int getNowLineNumber()
        +List~List~String~~ getRows()
        +boolean initialize(Path inputPath, Path outputPath)
        +boolean readOneLineOfData()
        +boolean writeIntermediateFile()
    }

    class AbstractIctoOneLinePatternLogic {
        -Logger logger
        -KmgMessageSource messageSource
        -Path inputPath
        -Path outputPath
        -BufferedReader reader
        -BufferedWriter writer
        -String lineOfDataRead
        -String convertedLine
        -KmgDelimiterTypes outputDelimiter
        -int nowLineNumber
        -List~List~String~~ rows
        +AbstractIctoOneLinePatternLogic()
        +boolean addOneLineOfDataToRows()
        +boolean clearProcessingData()
        +boolean clearRows()
        +String getConvertedLine()
        +String getLineOfDataRead()
        +int getNowLineNumber()
        +List~List~String~~ getRows()
        +boolean initialize(Path inputPath, Path outputPath)
        +boolean readOneLineOfData()
        +boolean writeIntermediateFile()
        -boolean addRow(String data)
        -boolean replaceInLine(String target, String replacement)
        -void closeReader()
        -void closeWriter()
        -void openInputFile()
        -void openOutputFile()
    }

    class DtcService {
        <<interface>>
        +boolean initialize(Path inputPath, Path templatePath, Path outputPath)
        +boolean process()
    }

    class KmgDelimiterTypes {
        <<enumeration>>
        +COMMA
        +TAB
        +SEMICOLON
        +SPACE
        +String join(List~String~)
    }

    class IitoTool.yml {
        intermediatePlaceholders
        derivedPlaceholders
        templateContent
    }
```

## 2. シーケンス図

```mermaid
sequenceDiagram
    participant User as ユーザー
    participant IitoTool as IitoTool
    participant AIT as AbstractIitoTool
    participant AT2OT as AbstractTwo2OneTool
    participant AIT2 as AbstractIoTool
    participant IitoService as AbstractIitoProcessorService
    participant IctoLogic as AbstractIctoOneLinePatternLogic
    participant DtcService as DtcService
    participant Template as IitoTool.yml
    participant Input as input.txt
    participant Intermediate as intermediate.tmp
    participant Output as output.txt

    User->>IitoTool: アプリケーション起動
    Note over IitoTool: main(String[] args)
    IitoTool->>IitoTool: SpringApplication.run
    IitoTool->>IitoTool: run(args)

    IitoTool->>AT2OT: initialize()
    AT2OT->>IitoService: initialize(inputPath, templatePath, outputPath)
    IitoService->>IitoService: パス設定
    IitoService->>IitoService: createTempntermediateFile()
    Note over IitoService: 一時中間ファイル作成

    IitoTool->>AIT2: execute()
    AIT2->>IitoTool: getIoService()
    IitoTool-->>AIT2: iitoProcessorService
    AIT2->>IitoService: process()

    IitoService->>IitoLogic: initialize(inputPath, intermediatePath)
    IitoLogic->>IitoLogic: ファイルオープン処理

    loop 入力ファイル処理
        IitoService->>IitoLogic: readOneLineOfData()
        IitoLogic-->>Input: ファイル読み込み
        IitoLogic->>IitoLogic: 1行データ取得

        IitoService->>IitoLogic: addOneLineOfDataToRows()
        IitoLogic->>IitoLogic: 行データ追加

        IitoService->>IitoLogic: writeIntermediateFile()
        IitoLogic->>Intermediate: 中間ファイル書き込み
    end

    IitoService->>IitoLogic: close()
    IitoLogic->>IitoLogic: リソースクローズ

    IitoService->>DtcService: initialize(intermediatePath, templatePath, outputPath)
    DtcService->>DtcService: パス設定

    IitoService->>DtcService: process()
    DtcService->>Template: YAMLファイル読み込み
    DtcService->>DtcService: テンプレートコンテンツ解析
    DtcService->>Intermediate: 中間ファイル読み込み
    DtcService->>DtcService: プレースホルダー処理
    DtcService->>Output: 出力ファイル生成

    IitoTool-->>User: 処理完了
```

## 3. パッケージ構成図

```mermaid
graph TB
    subgraph "kmg.tool.iito"
        subgraph "domain"
            subgraph "logic"
                IctoOneLinePatternLogic["IctoOneLinePatternLogic<br/>1行パターンロジックインターフェース"]
                AbstractIctoOneLinePatternLogic["AbstractIctoOneLinePatternLogic<br/>1行パターンロジック抽象クラス"]
            end

            subgraph "service"
                IitoProcessorService["IitoProcessorService<br/>IITOプロセッササービスインターフェース"]
                AbstractIitoProcessorService["AbstractIitoProcessorService<br/>IITOプロセッササービス抽象クラス"]
            end
        end

        subgraph "presentation"
            subgraph "ui"
                subgraph "cli"
                    IitoTool["IitoTool<br/>IITOツール"]
                end
            end
        end
    end

    subgraph "kmg.tool.two2one"
        subgraph "domain"
            subgraph "service"
                Two2OneService["Two2OneService<br/>2入力1出力サービス"]
            end
        end

        subgraph "presentation"
            subgraph "ui"
                subgraph "cli"
                    AbstractTwo2OneTool["AbstractTwo2OneTool<br/>2入力1出力ツール抽象クラス"]
                end
            end
        end
    end

    subgraph "kmg.tool.dtc"
        subgraph "domain"
            subgraph "service"
                DtcService["DtcService<br/>DTCサービス"]
            end
        end
    end

    subgraph "kmg.core"
        subgraph "infrastructure"
            subgraph "types"
                KmgDelimiterTypes["KmgDelimiterTypes<br/>区切り文字タイプ"]
            end
        end
    end

    %% 依存関係
    IitoProcessorService --> Two2OneService
    AbstractIitoProcessorService --> IctoOneLinePatternLogic
    AbstractIitoProcessorService --> DtcService
    AbstractIctoOneLinePatternLogic --> KmgDelimiterTypes
    IitoTool --> AbstractIitoProcessorService
```

## 4. 処理フロー詳細

1. ユーザーがアプリケーションを起動
2. SpringBoot アプリケーションが起動し、IitoTool のインスタンスが生成される
3. AbstractTwo2OneTool の initialize()メソッドが呼び出され、IitoProcessorService が初期化される
4. 一時的な中間ファイルが作成される
5. AbstractIoTool の execute()メソッドが呼び出され、メイン処理が実行される
6. AbstractIitoProcessorService の process()メソッドが実行され、以下の処理が開始される：
   - AbstractIctoOneLinePatternLogic の初期化（入力ファイル、中間ファイルのオープン）
   - 入力ファイルから 1 行ずつデータを読み込み、中間ファイルに書き込む
   - 中間ファイルの処理完了後、DtcService を使用してテンプレート変換を実行
   - 最終的な出力ファイルを生成
7. リソースがクローズされ、処理が完了する

## 5. 主要コンポーネント

### IitoTool

- SpringBootApplication として動作するエントリーポイント
- AbstractIitoTool を継承（さらに AbstractTwo2OneTool を継承）
- IitoProcessorService を使用して入力 → 中間 → 出力処理を実行

### AbstractIitoTool

- AbstractTwo2OneTool を継承
- 入力 → 中間 → 出力ツールの抽象クラス
- IitoProcessorService を返す抽象メソッドを定義

### AbstractIitoProcessorService

- Two2OneService インターフェースを実装
- AbstractIctoOneLinePatternLogic を使用して入力ファイルから中間ファイルへの変換処理を実行
- DtcService を使用して中間ファイルから最終出力ファイルへの変換処理を実行
- 一時的な中間ファイルの作成と管理を担当

### AbstractIctoOneLinePatternLogic

- IctoOneLinePatternLogic インターフェースを実装
- 入力ファイルから中間ファイルへの変換の実際のロジックを担当
- 1 行ずつデータを読み込み、指定された区切り文字で区切って中間ファイルに出力
- ファイルの読み込み、変換、書き込み処理を管理

### IctoOneLinePatternLogic

- 入力 → 中間 → 出力の 1 行パターン処理のインターフェース
- ファイルの初期化、データ読み込み、変換、書き込みの基本操作を定義
- 行データの管理とクリア機能を提供

### DtcService

- テンプレートの動的変換サービス
- 中間ファイルとテンプレートファイルを使用して最終出力ファイルを生成
- プレースホルダーの置換とテンプレート処理を実行

## 6. 設計思想

### 6.1 段階的処理

- 入力ファイル → 中間ファイル → 最終出力ファイルの 3 段階処理
- 各段階でのデータ変換と検証を可能にする
- 処理の分離による保守性の向上

### 6.2 再利用性

- AbstractIctoOneLinePatternLogic による 1 行パターン処理の抽象化
- 異なる入力形式に対応可能な拡張性
- テンプレート処理との組み合わせによる柔軟性

### 6.3 一時ファイル管理

- 自動的な一時ファイルの作成と削除
- 処理完了後のリソースクリーンアップ
- エラー時の適切なリソース解放

### 6.4 テンプレート連携

- DtcService との連携による高度なテンプレート処理
- 中間ファイルを介したデータ変換の柔軟性
- プレースホルダー処理の分離

## 7. 使用例

### 7.1 基本的な IITO ツール実装

```java
public class CustomIitoTool extends AbstractIitoTool {
    private final IitoProcessorService iitoProcessorService;

    public CustomIitoTool(String toolName, IitoProcessorService iitoProcessorService) {
        super(toolName);
        this.iitoProcessorService = iitoProcessorService;
    }

    @Override
    protected IitoProcessorService getIoService() {
        return this.iitoProcessorService;
    }
}
```

### 7.2 1 行パターンロジックの実装

```java
public class CustomIctoOneLinePatternLogic extends AbstractIctoOneLinePatternLogic {

    @Override
    protected boolean processLine() {
        // カスタム行処理ロジック
        return this.addRow(this.getLineOfDataRead());
    }
}
```

### 7.3 中間ファイル処理

```java
// 入力ファイルから中間ファイルへの変換
iitoLogic.initialize(inputPath, intermediatePath);
while (iitoLogic.readOneLineOfData()) {
    // 行データの処理
    iitoLogic.addOneLineOfDataToRows();
}
iitoLogic.writeIntermediateFile();

// 中間ファイルから最終出力への変換
dtcService.initialize(intermediatePath, templatePath, outputPath);
dtcService.process();
```
